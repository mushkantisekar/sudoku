(ns sudoku.engine-test (:require [sudoku.engine :refer :all]
            #?(:clj [clojure.test :refer :all]
               :cljs [cljs.test :refer :all :include-macros true])))

(let [_ nil]
  (def sk-solved
    [[1 2 3 4 5 6 7 8 9]
     [4 5 6 7 8 9 1 2 3]
     [7 8 9 1 2 3 4 5 6]
     [2 3 4 5 6 7 8 9 1]
     [5 6 7 8 9 1 2 3 4]
     [8 9 1 2 3 4 5 6 7]
     [3 4 5 6 7 8 9 1 2]
     [6 7 8 9 1 2 3 4 5]
     [9 1 2 3 4 5 6 7 8]])

  (def sk-invalid
    [[2 2 3 4 5 6 7 8 9]
     [4 5 6 7 8 9 1 2 3]
     [7 8 9 1 2 3 4 5 6]
     [2 3 4 5 6 7 8 9 1]
     [5 6 7 8 9 1 2 3 4]
     [8 9 1 2 3 4 5 6 7]
     [3 4 5 6 7 8 9 1 2]
     [6 7 8 9 1 2 3 4 5]
     [9 1 2 3 4 5 6 7 8]])

  (def sk-directly-solvable
    [[1 _ 3 4 _ 6 7 _ _]
     [4 _ 6 _ 8 _ _ _ 3]
     [_ 8 9 _ 2 3 _ 5 _]
     [2 _ 4 _ _ 7 _ _ _]
     [_ _ 7 _ 9 _ _ 3 _]
     [8 _ _ 2 _ 4 _ 6 _]
     [_ _ 5 _ 7 _ _ _ 2]
     [6 _ 8 _ _ 2 _ 4 _]
     [9 _ 2 _ 4 _ 6 _ 8]])

  (def sk-open-single-solution
    [[1 _ _ 4 _ 6 7 _ _]
     [4 _ 6 _ 8 _ _ _ 3]
     [_ 8 _ _ 2 _ _ 5 _]
     [2 _ 4 _ _ 7 _ _ _]
     [_ _ 7 _ 9 _ _ 3 _]
     [8 _ _ 2 _ 4 _ 6 _]
     [_ _ _ _ 7 _ _ _ 2]
     [6 _ 8 _ _ 2 _ 4 _]
     [9 _ _ _ 4 _ 6 _ 8]])

  (def sk-open-multiple-solutions
    [[1 _ _ 4 _ _ 7 _ _]
     [4 _ 6 _ 8 _ _ _ 3]
     [_ 8 _ _ 2 _ _ 5 _]
     [2 _ 4 _ _ 7 _ _ _]
     [_ _ 7 _ _ _ _ 3 _]
     [8 _ _ 2 _ 4 _ 6 _]
     [_ _ _ _ 7 _ _ _ 2]
     [6 _ 8 _ _ 2 _ 4 _]
     [9 _ _ _ 4 _ 6 _ 8]])

  (def sk-unsolvable
    [[1 _ _ 4 _ _ 7 _ _]
     [4 _ 6 _ 8 _ _ _ 3]
     [_ 8 _ _ 2 _ _ 5 _]
     [2 _ 4 _ _ 7 _ _ _]
     [_ _ 7 _ _ _ _ 3 _]
     [8 _ _ 2 _ 4 _ 6 _]
     [_ _ _ _ 7 _ _ _ 2]
     [6 _ 8 _ _ 2 _ 5 _]
     [9 _ _ _ 4 _ 6 _ 8]]))

(deftest test-options-cell
  (is (= #{2 5} (options-cell
                 sk-directly-solvable 0 1 nil)))
  (is (= #{5} (options-cell
               sk-directly-solvable 0 4 nil)))
  (is (= #{1 2 3 4 5 6 7 8 9} (options-cell
               sk-empty 0 0 nil)))
  (is (= #{3} (options-cell
               sk-directly-solvable 0 2 3))))

(deftest test-solved?
  (is (= true (solved? sk-solved)))
  (is (= false (solved? sk-invalid)))
  (is (= false (solved? sk-directly-solvable)))
  (is (= false (solved? sk-empty)))
  (is (= false (solved? sk-unsolvable)))
  (is (= false (solved? sk-open-single-solution)))
  (is (= false (solved? sk-open-multiple-solutions))))

(deftest test-options
  ;; Don't panic. I copied these from the repl...
  (is (= (options sk-solved)
         [[#{1} #{2} #{3} #{4} #{5} #{6} #{7} #{8} #{9}]
          [#{4} #{5} #{6} #{7} #{8} #{9} #{1} #{2} #{3}]
          [#{7} #{8} #{9} #{1} #{2} #{3} #{4} #{5} #{6}]
          [#{2} #{3} #{4} #{5} #{6} #{7} #{8} #{9} #{1}]
          [#{5} #{6} #{7} #{8} #{9} #{1} #{2} #{3} #{4}]
          [#{8} #{9} #{1} #{2} #{3} #{4} #{5} #{6} #{7}]
          [#{3} #{4} #{5} #{6} #{7} #{8} #{9} #{1} #{2}]
          [#{6} #{7} #{8} #{9} #{1} #{2} #{3} #{4} #{5}]
          [#{9} #{1} #{2} #{3} #{4} #{5} #{6} #{7} #{8}]]))
  (is (= (options sk-invalid)
         [[#{} #{} #{3} #{4} #{5} #{6} #{7} #{8} #{9}]
          [#{4} #{5} #{6} #{7} #{8} #{9} #{1} #{2} #{3}]
          [#{7} #{8} #{9} #{1} #{2} #{3} #{4} #{5} #{6}]
          [#{} #{3} #{4} #{5} #{6} #{7} #{8} #{9} #{1}]
          [#{5} #{6} #{7} #{8} #{9} #{1} #{2} #{3} #{4}]
          [#{8} #{9} #{1} #{2} #{3} #{4} #{5} #{6} #{7}]
          [#{3} #{4} #{5} #{6} #{7} #{8} #{9} #{1} #{2}]
          [#{6} #{7} #{8} #{9} #{1} #{2} #{3} #{4} #{5}]
          [#{9} #{1} #{2} #{3} #{4} #{5} #{6} #{7} #{8}]]))
  (is (= (options sk-directly-solvable)
         [[#{1} #{2 5} #{3} #{4} #{5} #{6} #{7} #{2 9 8} #{9}]
          [#{4} #{7 2 5} #{6} #{7 1 9 5} #{8} #{1 9 5} #{1 2 9} #{1 2 9} #{3}]
          [#{7} #{8} #{9} #{7 1} #{2} #{3} #{1 4} #{5} #{1 4 6}]
          [#{2}
           #{1 6 3 9 5}
           #{4}
           #{1 6 3 5 8}
           #{1 6 3 5}
           #{7}
           #{1 9 5 8}
           #{1 9 8}
           #{1 9 5}]
          [#{5} #{1 6 5} #{7} #{1 6 5 8} #{9} #{1 5 8} #{1 4 2 5 8} #{3} #{1 4 5}]
          [#{8} #{1 3 9 5} #{1} #{2} #{1 3 5} #{4} #{1 9 5} #{6} #{7 1 9 5}]
          [#{3} #{1 4 3} #{5} #{1 6 3 9 8} #{7} #{1 9 8} #{1 3 9} #{1 9} #{2}]
          [#{6} #{7 1 3} #{8} #{1 3 9 5} #{1 3 5} #{2} #{1 3 9 5} #{4} #{7 1 9 5}]
          [#{9} #{7 1 3} #{2} #{1 3 5} #{4} #{1 5} #{6} #{7 1} #{8}]]))
  (is (= (options sk-empty)
         [[#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]
          [#{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}
           #{7 1 4 6 3 2 9 5 8}]]))
  (is (= (options sk-unsolvable)
         [[#{1} #{3 2 9 5} #{3 2 9 5} #{4} #{6 3 9 5} #{6 3 9 5} #{7} #{2 9 8} #{6 9}]
          [#{4} #{7 2 9 5} #{6} #{7 1 9 5} #{8} #{1 9 5} #{1 2 9} #{1 2 9} #{3}]
          [#{7 3} #{8} #{3 9} #{7 1 6 3 9} #{2} #{1 6 3 9} #{1 4 9} #{} #{1 4 6 9}]
          [#{2}
           #{1 6 3 9 5}
           #{4}
           #{1 6 3 9 5 8}
           #{1 6 3 9 5}
           #{7}
           #{1 9 5 8}
           #{1 9 8}
           #{1 9 5}]
          [#{5}
           #{1 6 9 5}
           #{7}
           #{1 6 9 5 8}
           #{1 6 9 5}
           #{1 6 9 5 8}
           #{1 4 2 9 5 8}
           #{3}
           #{1 4 9 5}]
          [#{8} #{1 3 9 5} #{1 3 9 5} #{2} #{1 3 9 5} #{4} #{1 9 5} #{6} #{7 1 9 5}]
          [#{3 5}
           #{1 4 3 5}
           #{1 3 5}
           #{1 6 3 9 5 8}
           #{7}
           #{1 6 3 9 5 8}
           #{1 4 3 9}
           #{1 4 9}
           #{2}]
          [#{6} #{7 1 4 3} #{8} #{1 3 9} #{1 3 9} #{2} #{1 4 3 9} #{} #{7 1 4 9}]
          [#{9} #{7 1 3 2 5} #{1 3 2 5} #{1 3 5} #{4} #{1 3 5} #{6} #{7 1} #{8}]]))
  (is (= (options sk-open-single-solution)
         [[#{1} #{3 2 9 5} #{3 2 9 5} #{4} #{3 5} #{6} #{7} #{2 9 8} #{9}]
          [#{4} #{7 2 9 5} #{6} #{7 1 9 5} #{8} #{1 9 5} #{1 2 9} #{1 2 9} #{3}]
          [#{7 3} #{8} #{3 9} #{7 1 3 9} #{2} #{1 3 9} #{1 4 9} #{5} #{1 4 6 9}]
          [#{2}
           #{1 6 3 9 5}
           #{4}
           #{1 6 3 5 8}
           #{1 6 3 5}
           #{7}
           #{1 9 5 8}
           #{1 9 8}
           #{1 9 5}]
          [#{5} #{1 6 5} #{7} #{1 6 5 8} #{9} #{1 5 8} #{1 4 2 5 8} #{3} #{1 4 5}]
          [#{8} #{1 3 9 5} #{1 3 9 5} #{2} #{1 3 5} #{4} #{1 9 5} #{6} #{7 1 9 5}]
          [#{3 5}
           #{1 4 3 5}
           #{1 3 5}
           #{1 6 3 9 5 8}
           #{7}
           #{1 3 9 5 8}
           #{1 3 9 5}
           #{1 9}
           #{2}]
          [#{6} #{7 1 3 5} #{8} #{1 3 9 5} #{1 3 5} #{2} #{1 3 9 5} #{4} #{7 1 9 5}]
          [#{9} #{7 1 3 2 5} #{1 3 2 5} #{1 3 5} #{4} #{1 3 5} #{6} #{7 1} #{8}]]))
  (is (= (options sk-open-multiple-solutions)
         [[#{1} #{3 2 9 5} #{3 2 9 5} #{4} #{6 3 9 5} #{6 3 9 5} #{7} #{2 9 8} #{6 9}]
          [#{4} #{7 2 9 5} #{6} #{7 1 9 5} #{8} #{1 9 5} #{1 2 9} #{1 2 9} #{3}]
          [#{7 3} #{8} #{3 9} #{7 1 6 3 9} #{2} #{1 6 3 9} #{1 4 9} #{5} #{1 4 6 9}]
          [#{2}
           #{1 6 3 9 5}
           #{4}
           #{1 6 3 9 5 8}
           #{1 6 3 9 5}
           #{7}
           #{1 9 5 8}
           #{1 9 8}
           #{1 9 5}]
          [#{5}
           #{1 6 9 5}
           #{7}
           #{1 6 9 5 8}
           #{1 6 9 5}
           #{1 6 9 5 8}
           #{1 4 2 9 5 8}
           #{3}
           #{1 4 9 5}]
          [#{8} #{1 3 9 5} #{1 3 9 5} #{2} #{1 3 9 5} #{4} #{1 9 5} #{6} #{7 1 9 5}]
          [#{3 5}
           #{1 4 3 5}
           #{1 3 5}
           #{1 6 3 9 5 8}
           #{7}
           #{1 6 3 9 5 8}
           #{1 3 9 5}
           #{1 9}
           #{2}]
          [#{6} #{7 1 3 5} #{8} #{1 3 9 5} #{1 3 9 5} #{2} #{1 3 9 5} #{4} #{7 1 9 5}]
          [#{9} #{7 1 3 2 5} #{1 3 2 5} #{1 3 5} #{4} #{1 3 5} #{6} #{7 1} #{8}]])))

(deftest test-invalid
  (is (= true (invalid? sk-invalid)))
  (is (= true (invalid? sk-unsolvable)))
  (is (= false (invalid? sk-empty)))
  (is (= false (invalid? sk-solved)))
  (is (= false (invalid? sk-directly-solvable)))
  (is (= false (invalid? sk-open-single-solution))))

(deftest test-complete-sudoku-once
  (is (= (complete-sudoku-once sk-empty) sk-empty))

  (is (= (complete-sudoku-once sk-directly-solvable)
         [[1 nil 3 4 5 6 7 nil 9]
          [4 nil 6 nil 8 nil nil nil 3]
          [7 8 9 nil 2 3 nil 5 nil]
          [2 nil 4 nil nil 7 nil nil nil]
          [5 nil 7 nil 9 nil nil 3 nil]
          [8 nil 1 2 nil 4 nil 6 nil]
          [3 nil 5 nil 7 nil nil nil 2]
          [6 nil 8 nil nil 2 nil 4 nil]
          [9 nil 2 nil 4 nil 6 nil 8]]))

  (is (= (complete-sudoku-once sk-open-single-solution)
         [[1 nil nil 4 nil 6 7 nil 9]
          [4 nil 6 nil 8 nil nil nil 3]
          [nil 8 nil nil 2 nil nil 5 nil]
          [2 nil 4 nil nil 7 nil nil nil]
          [5 nil 7 nil 9 nil nil 3 nil]
          [8 nil nil 2 nil 4 nil 6 nil]
          [nil nil nil nil 7 nil nil nil 2]
          [6 nil 8 nil nil 2 nil 4 nil]
          [9 nil nil nil 4 nil 6 nil 8]]))

  (is (= (complete-sudoku-once sk-open-multiple-solutions)
         [[1 nil nil 4 nil nil 7 nil nil]
          [4 nil 6 nil 8 nil nil nil 3]
          [nil 8 nil nil 2 nil nil 5 nil]
          [2 nil 4 nil nil 7 nil nil nil]
          [5 nil 7 nil nil nil nil 3 nil]
          [8 nil nil 2 nil 4 nil 6 nil]
          [nil nil nil nil 7 nil nil nil 2]
          [6 nil 8 nil nil 2 nil 4 nil]
          [9 nil nil nil 4 nil 6 nil 8]])))

(deftest test-complete-sudoku
  (is (= (complete-sudoku sk-empty) sk-empty))

  (is (= (complete-sudoku sk-directly-solvable)
         [[1 2 3 4 5 6 7 8 9]
          [4 5 6 7 8 9 1 2 3]
          [7 8 9 1 2 3 4 5 6]
          [2 3 4 5 6 7 8 9 1]
          [5 6 7 8 9 1 2 3 4]
          [8 9 1 2 3 4 5 6 7]
          [3 4 5 6 7 8 9 1 2]
          [6 7 8 9 1 2 3 4 5]
          [9 1 2 3 4 5 6 7 8]]))

  (is (= (complete-sudoku sk-open-single-solution)
         [[1 nil nil 4 nil 6 7 nil 9]
          [4 nil 6 nil 8 nil nil nil 3]
          [7 8 nil nil 2 nil nil 5 nil]
          [2 nil 4 nil nil 7 nil nil nil]
          [5 nil 7 nil 9 nil nil 3 nil]
          [8 nil nil 2 nil 4 nil 6 nil]
          [3 nil nil nil 7 nil nil nil 2]
          [6 nil 8 nil nil 2 nil 4 nil]
          [9 nil nil nil 4 nil 6 nil 8]]))

  (is (= (complete-sudoku sk-open-multiple-solutions)
         [[1 nil nil 4 nil nil 7 nil nil]
          [4 nil 6 nil 8 nil nil nil 3]
          [7 8 nil nil 2 nil nil 5 nil]
          [2 nil 4 nil nil 7 nil nil nil]
          [5 nil 7 nil nil nil nil 3 nil]
          [8 nil nil 2 nil 4 nil 6 nil]
          [3 nil nil nil 7 nil nil nil 2]
          [6 nil 8 nil nil 2 nil 4 nil]
          [9 nil nil nil 4 nil 6 nil 8]])))

(deftest test-solve-sudoku
  (is (= (first (solve-sudoku sk-solved))
         sk-solved))

  (is (= (solve-sudoku sk-open-single-solution)
         '([[1 2 3 4 5 6 7 8 9]
           [4 5 6 7 8 9 1 2 3]
           [7 8 9 1 2 3 4 5 6]
           [2 3 4 5 6 7 8 9 1]
           [5 6 7 8 9 1 2 3 4]
           [8 9 1 2 3 4 5 6 7]
           [3 4 5 6 7 8 9 1 2]
           [6 7 8 9 1 2 3 4 5]
           [9 1 2 3 4 5 6 7 8]])))

  (is (= (solve-sudoku sk-directly-solvable)
         '([[1 2 3 4 5 6 7 8 9]
           [4 5 6 7 8 9 1 2 3]
           [7 8 9 1 2 3 4 5 6]
           [2 3 4 5 6 7 8 9 1]
           [5 6 7 8 9 1 2 3 4]
           [8 9 1 2 3 4 5 6 7]
           [3 4 5 6 7 8 9 1 2]
           [6 7 8 9 1 2 3 4 5]
           [9 1 2 3 4 5 6 7 8]])))

  (let [sols (into #{} (solve-sudoku sk-open-multiple-solutions))]
    (is (= 42 (count sols)))
    (is (contains? sols
                   [[1 9 2 4 5 3 7 8 6]
                    [4 5 6 7 8 9 1 2 3]
                    [7 8 3 6 2 1 4 5 9]
                    [2 3 4 5 6 7 8 9 1]
                    [5 6 7 1 9 8 2 3 4]
                    [8 1 9 2 3 4 5 6 7]
                    [3 4 5 8 7 6 9 1 2]
                    [6 7 8 9 1 2 3 4 5]
                    [9 2 1 3 4 5 6 7 8]]))
    (is (contains? sols
                   [[1 9 2 4 5 3 7 8 6]
                    [4 5 6 7 8 9 1 2 3]
                    [7 8 3 6 2 1 4 5 9]
                    [2 3 4 5 6 7 8 9 1]
                    [5 6 7 9 1 8 2 3 4]
                    [8 1 9 2 3 4 5 6 7]
                    [3 4 5 8 7 6 9 1 2]
                    [6 7 8 1 9 2 3 4 5]
                    [9 2 1 3 4 5 6 7 8]]))))
